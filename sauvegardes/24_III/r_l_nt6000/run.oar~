#!/bin/bash
#OAR -l nodes=1/core=16,walltime=48:00:00
#OAR --project pr-seiscope
#OAR -n FWI3D

ulimit -s unlimited

source /applis/site/env.bash
module load intel-devel


cd $OAR_WORKDIR
# Number of cores
nbcores=`cat $OAR_NODE_FILE|wc -l`
# Number of nodes
nbnodes=`cat $OAR_NODE_FILE|sort|uniq|wc -l`
#Name of the first node
firstnode=`head -1 $OAR_NODE_FILE`
#Number of cores allocated on the first node (it is the same on all the nodes)
pernode=`grep $firstnode $OAR_NODE_FILE|wc -l`

cat $OAR_NODE_FILE
export MKL_NUM_THREADS=1
export OMP_NUM_THREADS=1

#sleep 60 
mpdboot -f $OAR_NODE_FILE -n 1 -r oarsh
mpdtrace
mpiexec -perhost 16 -ib -n 16 -envall ../bin/toyxdac_time >& out
mpdallexit


